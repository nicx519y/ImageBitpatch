# 图片批处理工具

一个基于 Node.js 的图片批处理脚本，支持图片等比缩放、多倍尺寸导出和 WebP 格式压缩。

## 功能特性

- ✅ 可配置输入和输出目录
- ✅ 按指定宽高比例裁剪图片
- ✅ 支持顶部、中部、底部三种裁剪位置
- ✅ 同时导出多个倍数尺寸（如 1x, 2x, 3x）
- ✅ 可配置压缩品质
- ✅ 自动转换为 WebP 格式
- ✅ 支持多种输入格式（JPG, PNG, BMP, TIFF, GIF, WebP）
- ✅ **支持多配置批量处理** - 一次运行处理多种不同的配置

## 安装依赖

```bash
npm install
```

## 使用方法

### 1. 准备图片文件

在项目根目录创建 `input` 文件夹，将需要处理的图片放入其中。

### 2. 配置参数（可选）

编辑 `config.json` 文件来自定义处理参数。现在支持**配置数组格式**，可以一次运行处理多种不同的配置：

```json
{
  "configs": [
    {
      "name": "标准配置",
      "inputDir": "./input",
      "outputDir": "./output",
      "targetWidth": 800,
      "targetHeight": 600,
      "cropPosition": "center",
      "scales": [1, 2, 3],
      "quality": 80,
      "supportedFormats": [".jpg", ".jpeg", ".png", ".bmp", ".tiff", ".gif", ".webp"]
    },
    {
      "name": "头像配置",
      "inputDir": "./input",
      "outputDir": "./output-avatar",
      "targetWidth": 400,
      "targetHeight": 400,
      "cropPosition": "top",
      "scales": [1, 2],
      "quality": 90,
      "supportedFormats": [".jpg", ".jpeg", ".png", ".bmp", ".tiff", ".gif", ".webp"]
    },
    {
      "name": "缩略图配置",
      "inputDir": "./input",
      "outputDir": "./output-thumb",
      "targetWidth": 300,
      "targetHeight": 200,
      "cropPosition": "center",
      "scales": [1],
      "quality": 70,
      "supportedFormats": [".jpg", ".jpeg", ".png", ".bmp", ".tiff", ".gif", ".webp"]
    }
  ]
}
```

**兼容性说明**：脚本仍然兼容旧的单一配置格式，如果使用旧格式，脚本会自动将其转换为配置数组处理。

### 3. 运行脚本

```bash
npm start
```

或者直接运行：

```bash
node index.js
```

## 配置参数说明

### 配置数组格式

新版本支持配置数组格式，可以在一次运行中处理多种不同的配置：

```json
{
  "configs": [
    { /* 配置1 */ },
    { /* 配置2 */ },
    { /* 配置3 */ }
  ]
}
```

### 单个配置参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `name` | string | `"未命名配置"` | 配置名称，用于日志显示和识别 |
| `inputDir` | string | `"./input"` | 输入图片目录路径 |
| `outputDir` | string | `"./output"` | 输出图片目录路径 |
| `targetWidth` | number | `800` | 目标宽度（像素） |
| `targetHeight` | number | `600` | 目标高度（像素） |
| `cropPosition` | string | `"center"` | 裁剪位置：`"top"`（顶部）、`"center"`（中部）、`"bottom"`（底部） |
| `scales` | array | `[1, 2, 3]` | 导出的倍数尺寸，会生成对应倍数的图片 |
| `quality` | number | `80` | WebP 压缩品质，范围 0-100，数值越高品质越好 |
| `supportedFormats` | array | `[".jpg", ".jpeg", ".png", ".bmp", ".tiff", ".gif", ".webp"]` | 支持的输入图片格式 |
| `maxWorkers` | number | `4` | 最大工作线程数，用于多线程处理 |

## 输出目录结构

不同倍数的图片会保存到对应的子目录中：
- 1x 尺寸：`output/x1/原文件名.webp`
- 2x 尺寸：`output/x2/原文件名.webp`
- 3x 尺寸：`output/x3/原文件名.webp`
- 以此类推...

## 示例

### 多配置处理示例

假设有一张名为 `photo.jpg` 的图片（原尺寸：1200x1600），使用上述配置数组，脚本会依次执行三个配置：

**配置1 - 标准配置**：
- 目标尺寸：800x600px，中部裁剪
- 生成：`output/x1/photo.webp` (800x600)、`output/x2/photo.webp` (1600x1200)、`output/x3/photo.webp` (2400x1800)

**配置2 - 头像配置**：
- 目标尺寸：400x400px，顶部裁剪
- 生成：`output-avatar/x1/photo.webp` (400x400)、`output-avatar/x2/photo.webp` (800x800)

**配置3 - 缩略图配置**：
- 目标尺寸：300x200px，中部裁剪
- 生成：`output-thumb/x1/photo.webp` (300x200)

### 运行日志示例

#### 顺序处理模式
```
=== 图片批处理工具 ===

加载了 3 个配置

使用顺序处理模式

=== 执行配置 1/3: 标准配置 ===
配置信息:
  输入目录: ./input
  输出目录: ./output
  目标尺寸: 800x600px
  裁剪位置: center
  导出倍数: 1, 2, 3
  压缩品质: 80
  最大线程数: 4

找到 5 个图片文件

使用多线程处理模式 (4 个工作线程)
处理进度: 5/5 (100%)
✅ 配置 "标准配置" 处理完成！

=== 执行配置 2/3: 头像配置 ===
...

🎉 所有配置处理完成！
```

#### 配置级并行处理模式
```
=== 图片批处理工具 ===

加载了 3 个配置

启用配置级并行处理模式

=== 开始配置 1/3: 标准配置 ===
=== 开始配置 2/3: 头像配置 ===
=== 开始配置 3/3: 缩略图配置 ===

配置信息: (并行显示)
...

✅ 配置 "头像配置" 处理完成！
✅ 配置 "缩略图配置" 处理完成！
✅ 配置 "标准配置" 处理完成！

🎉 所有配置处理完成！
```

## 裁剪功能说明

脚本会根据 `targetWidth` 和 `targetHeight` 的比例对图片进行智能裁剪：

### 裁剪逻辑
- **原图更宽**：保持高度不变，从中间裁剪宽度
- **原图更高**：保持宽度不变，根据 `cropPosition` 设置裁剪高度

### 裁剪位置选项
- `"top"`：从图片顶部开始裁剪
- `"center"`：从图片中部开始裁剪（默认）
- `"bottom"`：从图片底部开始裁剪

### 使用场景
- **头像处理**：使用 `"top"` 保留人物头部
- **风景照片**：使用 `"center"` 保留主要内容
- **产品图片**：使用 `"bottom"` 保留产品底部信息

## 多线程处理与性能优化

### 线程配置

- **`maxWorkers`**: 控制单个配置任务的最大工作线程数
  - 默认值：4
  - 建议值：CPU 核心数的 1-2 倍
  - 设置为 1 时使用单线程模式

### 处理模式

程序支持两种处理模式：

1. **配置级并行处理**：当满足以下条件时自动启用
   - 有多个配置需要处理
   - 所有配置的 `maxWorkers` 都 ≤ 2
   - 多个配置同时执行，充分利用系统资源

2. **顺序处理模式**：默认模式
   - 按配置数组顺序依次执行
   - 单个配置内部使用多线程处理文件

### 性能建议

- **小文件批量处理**：设置较高的 `maxWorkers` 值（4-8）
- **大文件处理**：设置较低的 `maxWorkers` 值（1-2），避免内存不足
- **多配置场景**：将各配置的 `maxWorkers` 设为 2，启用配置级并行
- **系统资源**：总线程数建议不超过 CPU 核心数的 2 倍

### 内存管理

程序已内置自动内存管理机制：

- **自动资源清理**：每张图片处理完成后自动销毁 Sharp 实例
- **垃圾回收优化**：支持强制垃圾回收，减少内存占用
- **启用垃圾回收**：使用 `--expose-gc` 参数启动程序以获得更好的内存管理
  ```bash
  node --expose-gc index.js
  ```
- **内存监控**：处理大量图片时建议监控系统内存使用情况

## 注意事项

1. 确保输入目录存在且包含支持的图片格式
2. 输出目录会自动创建（如果不存在）
3. 所有图片都会转换为 WebP 格式
4. 图片会按照目标宽高比进行裁剪，不是等比缩放
5. 裁剪后的图片会缩放到指定的目标尺寸
6. **多配置处理**：脚本会按顺序执行配置数组中的每个配置
7. **配置兼容性**：支持旧版本的单一配置格式，会自动转换为配置数组
8. **输出目录隔离**：不同配置可以使用不同的输出目录，避免文件覆盖
9. **配置命名**：建议为每个配置设置有意义的 `name` 字段，便于识别和调试
10. 多线程处理时请确保系统有足够的内存和 CPU 资源
11. **内存优化**：处理大量图片时建议使用 `node --expose-gc index.js` 启动以启用垃圾回收优化

## 依赖库

- [Sharp](https://sharp.pixelplumbing.com/) - 高性能图片处理库